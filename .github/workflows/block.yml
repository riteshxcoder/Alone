name: ðš»Õ°Ò½ ðš¨Åêª®â²›ð›† ðŸš©ð—§Îµá§˜â€Œá´

on:
  push:
  pull_request:

permissions:
  contents: write
  pull-requests: write

jobs:
  full-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Add uv to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Sync from uv.lock
        run: uv sync --frozen

      - name: Install tools
        run: uv pip install black isort ruff pip-audit

      - name: Format all python files
        run: |
          uv run black .
          uv run isort .

      # âœ… IMPORTANT FIX HERE
      - name: Ruff auto-fix (never fail)
        run: |
          uv run ruff check . \
            --fix \
            --unsafe-fixes \
            --exit-zero

      - name: Check uv.lock consistency
        run: |
          uv lock
          if [ -n "$(git status --porcelain)" ]; then
            echo "CHANGED=true" >> $GITHUB_ENV
          else
            echo "CHANGED=false" >> $GITHUB_ENV
          fi

      - name: Dependency audit
        continue-on-error: true
        run: uv run pip-audit

      - name: Create Pull Request
        if: env.CHANGED == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "Auto update: full repo check"
          title: "âœ… Automated full repo auto-fix"
          body: |
            âœ” Black formatting  
            âœ” Import sorting  
            âœ” Ruff auto-fix (safe + unsafe)  
            âœ” uv.lock synced  

            CI will never fail on lint errors.
          labels: auto-fix, uv, ci
          branch: repo-auto-check-${{ github.run_id }}
          delete-branch: true
