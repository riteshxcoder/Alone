#!/bin/bash
# ===============================================
# AloneMusic Auto Installer Script (VPS / Ubuntu)
# Repository: TheAloneTeam/AloneMusic
# ===============================================

# Color definitions
red='\033[0;31m'
green='\033[0;32m'
yellow='\033[1;33m'
blue='\033[0;34m'
purple='\033[0;35m'
reset='\033[0m'

pprint(){
  printf "${2:-$purple}%b${reset}" "$1"
}

color_reset(){ printf "${reset}"; }

yesnoprompt(){
  old_stty_cfg=$(stty -g)
  stty raw -echo ; answer=$(head -c 1)
  stty $old_stty_cfg
  echo "$answer" | grep -iq "^y"
}

# ===============================================
update_system(){
  pprint "\n\nUpdating system packages... " "$blue"
  sudo apt update -y && sudo apt upgrade -y \
    && pprint "DONE\n" "$green" || { pprint "FAIL\n" "$red"; exit 1; }
}

install_dependencies(){
  pprint "\nInstalling required system packages...\n" "$yellow"
  sudo apt install -y python3 python3-pip git ffmpeg libffi-dev libopus0 \
    && pprint "System packages installed.\n" "$green" \
    || { pprint "Failed installing system packages.\n" "$red"; exit 1; }
}

clone_repo(){
  pprint "\nCloning the repository...\n" "$yellow"
  if [ ! -d "AloneMusic" ]; then
    git clone https://github.com/TheAloneTeam/AloneMusic.git \
      && pprint "Repository cloned.\n" "$green" \
      || { pprint "Failed to clone repository.\n" "$red"; exit 1; }
  else
    pprint "Repository folder already exists, pulling latest...\n" "$yellow"
    cd AloneMusic && git pull && cd .. \
      && pprint "Updated repository.\n" "$green" \
      || { pprint "Failed to update repository.\n" "$red"; exit 1; }
  fi
}

install_python_packages(){
  pprint "\nInstalling Python dependencies...\n" "$yellow"
  cd AloneMusic \
    && python3 -m pip install --upgrade pip setuptools wheel \
    && python3 -m pip install . \
    && pprint "Python dependencies installed.\n" "$green" \
    || { pprint "Python dependencies installation failed. Check logs.\n" "$red"; exit 1; }
}

setup_env(){
  pprint "\nSetting up environment variables (.env)\n" "$blue"

  cp AloneMusic/sample.env AloneMusic/.env
  pprint "Please edit the .env file and fill in your values (BOT_TOKEN, API_ID, API_HASH, MONGO_DB_URI, etc.)\n" "$yellow"
  pprint "Press ENTER when youâ€™re ready to continueâ€¦" "$purple"
  read

  cd AloneMusic
  pprint "\nStarting the bot now...\n\n" "$green"
  python3 -m AloneMusic.bot
}

# ===============================================
# Main execution
clear
pprint "Welcome to AloneMusic VPS Installer ðŸš€\n" "$purple"
sleep 1

update_system
install_dependencies
clone_repo
install_python_packages
setup_env
